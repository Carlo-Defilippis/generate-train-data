<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Police Narrative Trainer</title>
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />
  <style>
    .edited::after {
      content: '\2713'; /* checkmark */
      color: green;
      margin-left: 8px;
    }
    textarea {
      resize: vertical;
    }
    #uploadInput {
      display: none;
    }
  </style>
</head>
<body class="bg-light">
  <div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h1 class="h4">Editable Police Prompts</h1>
      <div class="d-flex gap-2">
        <button class="btn btn-secondary" onclick="document.getElementById('uploadInput').click()">Upload Exported JSON</button>
        <button class="btn btn-primary" onclick="downloadJSON()">Export JSON</button>
        <input type="file" id="uploadInput" accept=".json" onchange="handleFileUpload(event)" />
      </div>
    </div>
    <div id="prompt-container"></div>
  </div>

  <script>
    let data = [];

    async function loadData() {
      const response = await fetch('https://raw.githubusercontent.com/Carlo-Defilippis/generate-train-data/refs/heads/main/narratives.json?cb=' + Date.now());
      data = await response.json();
      renderData();
    }

    function renderData() {
      const container = document.getElementById('prompt-container');
      container.innerHTML = ''; // Clear previous content

      data.forEach((entry, index) => {
        const card = document.createElement('div');
        card.className = 'card mb-4';

        const body = document.createElement('div');
        body.className = 'card-body';

        const userPromptLabel = document.createElement('label');
        userPromptLabel.className = 'form-label fw-bold';
        userPromptLabel.textContent = `User Prompt #${index + 1}`;

        const userPromptTextarea = document.createElement('textarea');
        userPromptTextarea.className = 'form-control mb-3';
        userPromptTextarea.value = entry['User Prompt'];
        userPromptTextarea.rows = 3;
        userPromptTextarea.addEventListener('input', () => {
          entry['User Prompt'] = userPromptTextarea.value;
          userPromptLabel.classList.add('edited');
        });

        const narrativeLabel = document.createElement('label');
        narrativeLabel.className = 'form-label fw-bold';
        narrativeLabel.textContent = `Narrative #${index + 1}`;

        const narrativeTextarea = document.createElement('textarea');
        narrativeTextarea.className = 'form-control';
        narrativeTextarea.value = entry['Narrative'];
        narrativeTextarea.rows = 6;
        narrativeTextarea.addEventListener('input', () => {
          entry['Narrative'] = narrativeTextarea.value;
          narrativeLabel.classList.add('edited');
        });

        body.appendChild(userPromptLabel);
        body.appendChild(userPromptTextarea);
        body.appendChild(narrativeLabel);
        body.appendChild(narrativeTextarea);

        card.appendChild(body);
        container.appendChild(card);
      });
    }

    function handleFileUpload(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          data = JSON.parse(e.target.result);
          renderData();
        } catch (err) {
          alert("Invalid JSON file.");
        }
      };
      reader.readAsText(file);
    }

    function downloadJSON() {
      const blob = new Blob([JSON.stringify(data, null, 2)], {
        type: 'application/json'
      });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'exported_narratives.json';
      a.click();
      URL.revokeObjectURL(url);
    }

    window.onload = loadData;
  </script>
</body>
</html>
